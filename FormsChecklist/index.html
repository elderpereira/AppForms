<!DOCTYPE html>
<html>
<head>
    <title>Checklist DTQ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h1>Checklist DTQ</h1>
        <form id="FormChecklist">

            <!-- vamos começar sem identificação de equipe -->

            <!-- <div class="form-group">
                <label for="gerencia">Gerência:</label>
                <input type="text" id="gerencia" name="gerencia" class="form-control">
            </div>
            <div class="form-group">
                <label for="coordenacao">Coordenação:</label>
                <input type="text" id="coordenacao" name="coordenacao" class="form-control">
            </div>
            <div class="form-group">
                <label for="equipe">Equipe:</label>
                <input type="text" id="equipe" name="equipe" class="form-control">
            </div> -->

            <div class="form-group">
                <label for="SUB">SUB:</label>
                <input type="text" id="SUB" name="SUB" class="form-control" value="$$SUB$$">
            </div>
            <div class="form-group">
                <label for="dataHoraAlarme">Data Hora Alarme:</label>
                <input type="datetime-local" id="dataHoraAlarme" name="dataHoraAlarme" class="form-control" value="$$dataHoraAlarme$$">
            </div>
            <div class="form-group" style="display: flex; align-items: center;">
                <label for="rondaRealizadaEmbarcada" style="margin-right: 10px;">Ronda realizada embarcada:</label>
                <div style="margin-right: 10px;">
                    <input type="radio" id="rondaRealizadaEmbarcadaSim" name="rondaRealizadaEmbarcada" value="sim">
                    <label for="rondaRealizadaEmbarcadaSim">Sim</label>
                </div>
                <div>
                    <input type="radio" id="rondaRealizadaEmbarcadaNao" name="rondaRealizadaEmbarcada" value="nao">
                    <label for="rondaRealizadaEmbarcadaNao">Não</label>
                </div>
            </div>
            <div class="form-group">
                <label for="clima">Clima:</label>
                <select id="clima" name="clima" class="form-control">
                    <option value="seco">Seco</option>
                    <option value="umido">Úmido</option>
                    <option value="chuva">Chuva</option>
                </select>
            </div>
            <!-- div com imagem DTQ.png que se ajusta para facilitar entender valores de kms -->
            <div class="form-group">
                <img src="DTQ.png" alt="DTQ" style="width: 100%; height: auto;">
            </div>
            
            

            <div class="form-group" style="display: flex; justify-content: space-between;">
                <div style="text-align: center; margin-right: 10px;">
                    <input type="text" id="kmFisicoJ1" name="kmFisicoJ1" class="form-control">
                    <label for="kmFisicoJ1" style="margin-top: -5px; font-size: 0.8em;">Km Físico J1:</label>
                </div>
                <div style="text-align: center; margin-right: 10px;">
                    <input type="text" id="kmFisicoDTQ" name="kmFisicoDTQ" class="form-control">
                    <label for="kmFisicoDTQ" style="margin-top: -5px; font-size: 0.8em;">Km Físico DTQ:</label>
                </div>
                <div style="text-align: center;">
                    <input type="text" id="kmFisicoJ2" name="kmFisicoJ2" class="form-control">
                    <label for="kmFisicoJ2" style="margin-top: -5px; font-size: 0.8em;">Km Físico J2:</label>
                </div>
            </div>

            <!-- 
                Presença de Boletim de VIA: [Sim][Não]

                Detectou Trilho Quebrado: [Sim][[Não] {KM da Fratura: {Causa: [Sobre a Placa][Topado][Totalmente aberto]}}

                Detectado Bondeamento rompido: [Sim][[Não] {KM do bondeamento: {Causa: [Desgaste do material][Equipe trabalhando no local][Solda mal feita]}}

                Condições das talas: [OK][N/OK] Causa: [faltando parafuso][Tricada][Junta aberto][Quebrada]
                Condições dos lastros: [OK][N/OK] Causa: [Contaminado][Bolsão]
                Verificar condições dos cabos de alimentação: [OK][N/OK] Causa: [Vandalismo][Desgaste do Material][Equipe Trabalhando no local][Solda mal feita]
                Verifcar condições dos Jumpers: [OK][N/OK] Causa: [Vandalismo][Desgaste do material][Equipe trabalhando no local][Solda mal feita]
                "Verificar presença de tacos: : [OK][N/OK] Causa: [Solto][Sem Bondeamento][Com Bondeamento]
                OK: não tem tacos  NOK: presença de tacos"
                Verificar condições da PN: [OK][N/OK]
             -->
            <div class="form-group" style="display: flex; align-items: center;">
                <label style="margin-right: 10px;">Presença de Boletim de VIA:</label>
                <div style="margin-right: 10px;">
                    <input type="radio" id="presencaBoletimVIASim" name="presencaBoletimVIA" value="sim">
                    <label for="presencaBoletimVIASim">Sim</label>
                </div>
                <div>
                    <input type="radio" id="presencaBoletimVIANao" name="presencaBoletimVIA" value="nao">
                    <label for="presencaBoletimVIANao">Não</label>
                </div>
            </div>
            <!-- Trilho quebrado -->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Detectou Trilho Quebrado:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="detectouTrilhoQuebradoSim" name="detectouTrilhoQuebrado" value="sim" onclick="showDetails(true)">
                        <label for="detectouTrilhoQuebradoSim">Sim</label>
                    </div>
                    <div>
                        <input type="radio" id="detectouTrilhoQuebradoNao" name="detectouTrilhoQuebrado" value="nao" onclick="showDetails(false)">
                        <label for="detectouTrilhoQuebradoNao">Não</label>
                    </div>
                </div>
                <div id="details" style="display: none;">
                    <div>
                        <label for="kmFratura">KM da Fratura:</label>
                        <input type="text" id="kmFratura" name="kmFratura" class="form-control">
                    </div>
                    <div>
                        <label for="causa">Causa:</label>
                        <select id="causa" name="causa" class="form-control">
                            <option value="sobrePlaca">Sobre a Placa</option>
                            <option value="topado">Topado</option>
                            <option value="totalmenteAberto">Totalmente aberto</option>
                        </select>
                    </div>
                </div>
            </div>

            <script>
                function showDetails(show) {
                    document.getElementById('details').style.display = show ? 'block' : 'none';
                }
                </script>
            
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Detectado Bondeamento rompido:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="detectadoBondeamentoRompidoSim" name="detectadoBondeamentoRompido" value="sim" onclick="showDetailsBondeamento(true)">
                        <label for="detectadoBondeamentoRompidoSim">Sim</label>
                    </div>
                    <div>
                        <input type="radio" id="detectadoBondeamentoRompidoNao" name="detectadoBondeamentoRompido" value="nao" onclick="showDetailsBondeamento(false)">
                        <label for="detectadoBondeamentoRompidoNao">Não</label>
                    </div>
                </div>
                <div id="detailsBondeamento" style="display: none;">
                    <button type="button" onclick="addBondeamento()">Adicionar Bondeamento Rompido</button>
                    <div id="bondeamentos"></div>
                </div>
            </div>
            
            <script>
            function showDetailsBondeamento(show) {
                document.getElementById('detailsBondeamento').style.display = show ? 'block' : 'none';
            }
            
            function addBondeamento() {
                var bondeamentosDiv = document.getElementById('bondeamentos');
            
                var bondeamentoDiv = document.createElement('div');
                bondeamentoDiv.className = 'bondeamento';
            
                var kmDiv = document.createElement('div');
                var kmLabel = document.createElement('label');
                kmLabel.textContent = 'KM do bondeamento:';
                var kmInput = document.createElement('input');
                kmInput.type = 'text';
                kmInput.name = 'kmBondeamento';
                kmInput.className = 'form-control';
                kmDiv.appendChild(kmLabel);
                kmDiv.appendChild(kmInput);
            
                var causaDiv = document.createElement('div');
                var causaLabel = document.createElement('label');
                causaLabel.textContent = 'Causa:';
                var causaSelect = document.createElement('select');
                causaSelect.name = 'causaBondeamento';
                causaSelect.className = 'form-control';
                var opcoes = ['Desgaste do material', 'Equipe trabalhando no local', 'Solda mal feita', 'Vandalismo'];
                opcoes.forEach(function(opcao) {
                    var opcaoElement = document.createElement('option');
                    opcaoElement.value = opcao;
                    opcaoElement.textContent = opcao;
                    causaSelect.appendChild(opcaoElement);
                });
                causaDiv.appendChild(causaLabel);
                causaDiv.appendChild(causaSelect);
            
                var deleteButton = document.createElement('button');
                deleteButton.textContent = 'Excluir';
                deleteButton.onclick = function() {
                    bondeamentosDiv.removeChild(bondeamentoDiv);
                };
            
                bondeamentoDiv.appendChild(kmDiv);
                bondeamentoDiv.appendChild(causaDiv);
                bondeamentoDiv.appendChild(deleteButton);
            
                bondeamentosDiv.appendChild(bondeamentoDiv);
            }
            </script>
            <!-- condicoes Talas-->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Condições das talas:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="condicoesTalasOK" name="condicoesTalas" value="ok" onclick="showCausaTalas(false)">
                        <label for="condicoesTalasOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="condicoesTalasNOK" name="condicoesTalas" value="nok" onclick="showCausaTalas(true)">
                        <label for="condicoesTalasNOK">N/OK</label>
                    </div>
                </div>
                <!-- condicoes Talas Causas [OK][N/OK] Causa: [faltando parafuso][Tricada][Junta aberto][Quebrada]-->
                <div id="causaTalas" class="form-group" style="display: none;">
                    <label for="causa">Causa:</label>
                    <select id="causa" name="causaTalas" class="form-control">
                        <option value="faltandoParafuso">Faltando parafuso</option>
                        <option value="tricada">Tricada</option>
                        <option value="juntaAberto">Junta aberto</option>
                        <option value="quebrada">Quebrada</option>
                    </select>
                </div>
            </div>

            <script>
            function showCausaTalas(show) {
                document.getElementById('causaTalas').style.display = show ? 'block' : 'none';
            }
            </script>

            <!-- condicoes Lastros-->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Condições dos lastros:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="condicoesLastrosOK" name="condicoesLastros" value="ok" onclick="showCausaLastros(false)">
                        <label for="condicoesLastrosOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="condicoesLastrosNOK" name="condicoesLastros" value="nok" onclick="showCausaLastros(true)">
                        <label for="condicoesLastrosNOK">N/OK</label>
                    </div>
                </div>
                <!-- condicoes Lastros Causas [OK][N/OK] Causa: [Contaminado][Bolsão]-->
                <div id="causaLastros" class="form-group" style="display: none;">
                    <label for="causaLastrosSelect">Causa:</label>
                    <select id="causaLastrosSelect" name="causaLastros" class="form-control">
                        <option value="contaminado">Contaminado</option>
                        <option value="bolsao">Bolsão</option>
                    </select>
                </div>
            </div>
            
            <script>
            function showCausaLastros(show) {
                document.getElementById('causaLastros').style.display = show ? 'block' : 'none';
            }
            </script>
            <!-- condicoes cabos de alimentacao-->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Verificar condições dos cabos de alimentação:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="verificarCondicoesCabosAlimentacaoOK" name="verificarCondicoesCabosAlimentacao" value="ok" onclick="showCausaCabosAlimentacao(false)">
                        <label for="verificarCondicoesCabosAlimentacaoOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="verificarCondicoesCabosAlimentacaoNOK" name="verificarCondicoesCabosAlimentacao" value="nok" onclick="showCausaCabosAlimentacao(true)">
                        <label for="verificarCondicoesCabosAlimentacaoNOK">N/OK</label>
                    </div>
                </div>
                <!-- condicoes cabos de alimentacao Causas [OK][N/OK] Causa: [Vandalismo][Desgaste do Material][Equipe Trabalhando no local][Solda mal feita]-->
                <div id="causaCabosAlimentacao" class="form-group" style="display: none;">
                    <label for="causaCabosAlimentacaoSelect">Causa:</label>
                    <select id="causaCabosAlimentacaoSelect" name="causaCabosAlimentacao" class="form-control">
                        <option value="vandalismo">Vandalismo</option>
                        <option value="desgasteMaterial">Desgaste do Material</option>
                        <option value="equipeTrabalhandoLocal">Equipe Trabalhando no local</option>
                        <option value="soldaMalFeita">Solda mal feita</option>
                    </select>
                </div>
            </div>
            
            <script>
            function showCausaCabosAlimentacao(show) {
                document.getElementById('causaCabosAlimentacao').style.display = show ? 'block' : 'none';
            }
            </script>
            <!-- condicoes Jumpers-->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Verifcar condições dos Jumpers:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="verificarCondicoesJumpersOK" name="verificarCondicoesJumpers" value="ok" onclick="showCausaJumpers(false)">
                        <label for="verificarCondicoesJumpersOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="verificarCondicoesJumpersNOK" name="verificarCondicoesJumpers" value="nok" onclick="showCausaJumpers(true)">
                        <label for="verificarCondicoesJumpersNOK">N/OK</label>
                    </div>
                </div>
                <!-- condicoes Jumpers Causas [OK][N/OK] Causa: [Vandalismo][Desgaste do material][Equipe trabalhando no local][Solda mal feita]-->
                <div id="causaJumpers" class="form-group" style="display: none;">
                    <label for="causaJumpersSelect">Causa:</label>
                    <select id="causaJumpersSelect" name="causaJumpers" class="form-control">
                        <option value="vandalismo">Vandalismo</option>
                        <option value="desgasteMaterial">Desgaste do material</option>
                        <option value="equipeTrabalhandoLocal">Equipe trabalhando no local</option>
                        <option value="soldaMalFeita">Solda mal feita</option>
                    </select>
                </div>
            </div>
            
            <script>
            function showCausaJumpers(show) {
                document.getElementById('causaJumpers').style.display = show ? 'block' : 'none';
            }
            </script>
            <!-- condicoes tacos-->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Verificar presença de tacos:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="verificarPresencaTacosOK" name="verificarPresencaTacos" value="ok" onclick="showCausaTacos(false)">
                        <label for="verificarPresencaTacosOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="verificarPresencaTacosNOK" name="verificarPresencaTacos" value="nok" onclick="showCausaTacos(true)">
                        <label for="verificarPresencaTacosNOK">N/OK</label>
                    </div>
                </div>
                <!-- Causas tacos [OK][N/OK] Causa: [Solto][Sem Bondeamento][Com Bondeamento] -->
                <div id="causaTacos" class="form-group" style="display: none;">
                    <label for="causaTacosSelect">Causa:</label>
                    <select id="causaTacosSelect" name="causaTacos" class="form-control">
                        <option value="solto">Solto</option>
                        <option value="semBondeamento">Sem Bondeamento</option>
                        <option value="comBondeamento">Com Bondeamento</option>
                    </select>
                </div>
            </div>
            
            <script>
            function showCausaTacos(show) {
                document.getElementById('causaTacos').style.display = show ? 'block' : 'none';
            }
            </script>

            <!-- Condições dos Dormentes -->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Condição dos Dormentes:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="DormentesOK" name="CondicaoDormentes" value="ok">
                        <label for="DormentesOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="DormentesNOK" name="CondicaoDormentes" value="nok">
                        <label for="DormentesNOK">N/OK</label>
                    </div>
                </div>
            </div>

            <!-- Condição das Fixações -->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Condição das Fixações:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="FixacoesOK" name="CondicaoFixacoes" value="ok">
                        <label for="FixacoesOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="FixacoesNOK" name="CondicaoFixacoes" value="nok">
                        <label for="FixacoesNOK">N/OK</label>
                    </div>
                </div>
            </div>            


            <!-- condicoes PN-->
            <div class="form-group" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px;">Verificar condições da PN:</label>
                    <div style="margin-right: 10px;">
                        <input type="radio" id="verificarCondicoesPNOK" name="verificarCondicoesPN" value="ok" onclick="showObservacoesPN(false)">
                        <label for="verificarCondicoesPNOK">OK</label>
                    </div>
                    <div>
                        <input type="radio" id="verificarCondicoesPNNOK" name="verificarCondicoesPN" value="nok" onclick="showObservacoesPN(true)">
                        <label for="verificarCondicoesPNNOK">N/OK</label>
                    </div>
                </div>
                <!-- Observações PN [OK][N/OK] Observações:  -->
                <div id="observacoesPN" class="form-group" style="display: none;">
                    <label for="observacoesPNText">Observações:</label>
                    <textarea id="observacoesPNText" name="observacoesPN" class="form-control"></textarea>
                </div>
            </div>

            <script>
            function showObservacoesPN(show) {
                document.getElementById('observacoesPN').style.display = show ? 'block' : 'none';
            }
            </script>



            <div class="form-group">
            <button type="submit" class="btn btn-primary">Salvar Checklist</button>
            </div>
        </form>
    </div>

    <script>
    document.getElementById('FormChecklist').addEventListener('submit', function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        var object = {};
        var bondeamentos = [];
        var bondeamento = {};

        // Lista de campos obrigatórios
        var requiredFields = [
            'detectouTrilhoQuebrado',
            'presencaBoletimVIA',
            'detectadoBondeamentoRompido',
            'condicoesTalas',
            'condicoesLastros',
            'verificarCondicoesCabosAlimentacao',
            'verificarCondicoesJumpers',
            'verificarPresencaTacos',
            'CondicaoDormentes',
            'CondicaoFixacoes',
            'verificarCondicoesPN',
            'sb',
            'dataHoraAlarme',
            'rondaRealizadaEmbarcada',
            'clima',
            'kmFisicoJ1',
            'kmFisicoDTQ',
            'kmFisicoJ2'
        ];

        // Array para armazenar os campos obrigatórios que estão faltando
        var missingFields = [];

        // Verifica se todos os campos obrigatórios foram preenchidos
        for (var field of requiredFields) {
            if (!formData.has(field) || formData.get(field) == "") {
                missingFields.push(field);
            }
        }

        // Se houver campos obrigatórios faltando, mostra um alerta
        if (missingFields.length > 0) {
            alert("Por favor, preencha os seguintes campos obrigatórios:\n" + missingFields.join('\n'));
            return;
        }
        
            formData.forEach(function(value, key){
                if (key.startsWith('kmBondeamento')) {
                    bondeamento['kmBondeamento'] = value;
                } else if (key.startsWith('causaBondeamento')) {
                    bondeamento['causaBondeamento'] = value;
                    bondeamentos.push(bondeamento);
                    bondeamento = {};
                } else {
                    object[key] = value;
                }
            });
    
            object['bondeamentos'] = bondeamentos;
            var json = JSON.stringify(object);
    
            // Cria um novo objeto Blob com o JSON
            var blob = new Blob([json], {type: "application/json"});
    
            // Cria uma URL para o Blob
            var url = URL.createObjectURL(blob);
    
            // Cria um link e faz o download
            var downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = "data.json"; // nome do arquivo
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });
    </script>

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    </script>
    <script>
        // Get the URL fragment
        var fragment = window.location.hash.substring(1);

        // Split the fragment into an array of values
        var values = fragment.split(';');

        // Assign the values to variables
        var SUB = values[0];
        var dataHoraAlarme = values[1];
        var kmFisicoJ1 = values[2];
        var kmFisicoDTQ = values[3];
        var kmFisicoJ2 = values[4];

        // Convert the timestamp to a Date object
        var date = new Date(dataHoraAlarme * 1000);

        // Format the date as YYYY-MM-DD
        var dateStr = date.getFullYear() +
            '-' + ('0' + (date.getMonth() + 1)).slice(-2) +
            '-' + ('0' + date.getDate()).slice(-2);

        // Format the time as HH:mm
        var timeStr = ('0' + date.getHours()).slice(-2) +
            ':' + ('0' + date.getMinutes()).slice(-2);

        // Combine the date and time into a single string
        dataHoraAlarme = dateStr + 'T' + timeStr;

        // Set the values of the input fields
        document.getElementById('SUB').value = SUB;
        document.getElementById('dataHoraAlarme').value = dataHoraAlarme;
        document.getElementById('kmFisicoJ1').value = kmFisicoJ1;
        document.getElementById('kmFisicoDTQ').value = kmFisicoDTQ;
        document.getElementById('kmFisicoJ2').value = kmFisicoJ2;

        // Padrão de url que esta sendo tratado
        // #SUB;dataHoraAlarme;kmFisicoJ1;kmFisicoDTQ;kmFisicoJ2

    </script>

</body>
</body>
</html>